(function(global){var GROK=global.GROK,DEFAULT_XHR_METHOD="POST",DEFAULT_XHR_ENDPOINT="/grok",DEFAULT_XHR_HEADER="x-grok";function sendJsonpRequest(jxhr,url,opts){var myUrl=url+"?";jxhr.onerror=opts.failure;jxhr.onreadystatechange=function(data){if(jxhr.readyState===4){if(data.error&&opts.failure){opts.failure(new Error(data.error))}opts.success(JSON.parse(data))}};if(opts.data){myUrl+=GROK.util.toUriParams(opts.data)+"&callback=?"}else{myUrl+="callback=?"}jxhr.open(null,myUrl);jxhr.send()}function sendXhr(url,method,opts){var bundle,name,xhr=this._xhr,proxyEndpoint=this._proxyEndpoint||DEFAULT_XHR_ENDPOINT,apiKey=this._apiKey;opts.failure=opts.failure||function(){};xhr.open(DEFAULT_XHR_METHOD,proxyEndpoint);xhr.setRequestHeader("Content-Type","application/json;charset=UTF-8");xhr.setRequestHeader(DEFAULT_XHR_HEADER,"1");for(name in opts.headers){if(opts.headers.hasOwnProperty(name)){xhr.setRequestHeader(name,opts.headers[name])}}xhr.onreadystatechange=function(){var responseData,rawRespHeaders,respHeaders={};if(this.readyState==4&&this.status==200){if(opts.success){if(this.responseText){try{responseData=JSON.parse(this.responseText)}catch(e){responseData={errors:["Could not parse "+"response text from API server: "+this.responseText]}}if(responseData.errors){opts.failure(new Error(responseData.errors[0]))}else{opts.success(responseData,this.responseText)}}else{opts.success()}}}else if(this.readyState==4&&this.status!==0){if(opts.failure){rawRespHeaders=this.getAllResponseHeaders();if(rawRespHeaders){rawRespHeaders.split("\n").forEach(function(line){var parts=line.split(":"),value=parts[1].trim();if(!isNaN(parseFloat(value))&&isFinite(value)){value=new Number(value)}respHeaders[parts[0]]=value})}opts.failure(new Error("There was an XHR error, status is: "+this.status),parseInt(this.status),respHeaders)}}};bundle={proxy:{method:method,endpoint:url}};if(apiKey){bundle.apiKey=apiKey}if(opts.data){bundle.proxy.data=opts.data}xhr.send(JSON.stringify(bundle))}function shouldUseJsonp(httpMethod,opts){if(opts.forceProxy){return false}return httpMethod==="GET"}GROK.Request=function(options){var endpoint=options.endpoint,version=options.version,apiKey=options.apiKey,proxyEndpoint=options.proxyEndpoint,join="";if(!endpoint||!version){throw new Error("Cannot create GROK.Request object without "+"endpoint and version: \"new GROK.Request('/endpoint', "+"'version'\"")}this._apiKey=apiKey;this._proxyEndpoint=proxyEndpoint;this._xhr=new XMLHttpRequest;this._jxhr=new global.jXHR;if(endpoint.substr(endpoint.length-1,1)!=="/"){join="/"}this._root=endpoint+join+version;this.constructor=GROK.Request};GROK.Request.prototype.send=function(options){var httpMethod=options.method||"GET",url=options.url||this._root+"/"+options.path;httpMethod=httpMethod.toUpperCase();if(shouldUseJsonp(httpMethod,options)){sendJsonpRequest(this._jxhr,url,options)}else{sendXhr.call(this,url,httpMethod,options)}}})(window);