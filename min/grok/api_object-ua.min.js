(function(global){var GROK=global.GROK,DEFAULT={ENDPOINT:"https://api.groksolutions.com/",VERSION:"v2",FORCE_PROXY:true,TIMEOUT:3e4,RETRIES:2},REQUEST_STATUS={SENT:1,TIMEOUT:2};function merge(from,to,clobber){var name;if(!to){return from}if(typeof clobber==="undefined"){clobber=true}if(clobber){to=from}else{for(name in from){to[name]=from[name]}}return to}GROK.ApiObject=function(scalars,options){options=options||{};scalars=scalars||{};this.setScalars(scalars);this.setDetails({});this.setEndpoint(options.endpoint||DEFAULT.ENDPOINT);this.setProxyEndpoint(options.proxyEndpoint);this.setVersion(options.version||DEFAULT.VERSION);this.setTimeout(typeof options.timeout!=="undefined"?options.timeout:DEFAULT.TIMEOUT);this.setRetries(typeof options.retries!=="undefined"?options.retries:DEFAULT.RETRIES);this.setHeaders(options.httpHeaders||{});this.setUserId(options.userId);this.setApiKey(options.apiKey);this.rawJSON=options.rawJSON;this._requests={};this._requestIncrement=0};GROK.ApiObject.FORCE_PROXY=DEFAULT.FORCE_PROXY;GROK.ApiObject.prototype.getAttrs=function(){var s=this._scalars,d=this._details,out={},name;for(name in s){if(s.hasOwnProperty(name)&&name.indexOf("_")!==0){out[name]=s[name]}}for(name in d){if(d.hasOwnProperty(name)&&name.indexOf("_")!==0){out[name]=d[name]}}return out};GROK.ApiObject.prototype.getAttr=function(name){return this.get(name)};GROK.ApiObject.prototype.get=function(name){var result=this._scalars[name];if(!result&&this._details){result=this._details[name]}return result};GROK.ApiObject.prototype.getId=function(){return this.get("id")};GROK.ApiObject.prototype.setEndpoint=function(endpoint){this._apiEndpoint=endpoint};GROK.ApiObject.prototype.setProxyEndpoint=function(endpoint){this._proxyEndpoint=endpoint};GROK.ApiObject.prototype.getProxyEndpoint=function(){return this._proxyEndpoint};GROK.ApiObject.prototype.getEndpoint=function(){return this._apiEndpoint};GROK.ApiObject.prototype.setVersion=function(version){this._apiVersion=version};GROK.ApiObject.prototype.getVersion=function(){return this._apiVersion};GROK.ApiObject.prototype.setTimeout=function(timeout){this._timeout=timeout};GROK.ApiObject.prototype.getTimeout=function(){return this._timeout};GROK.ApiObject.prototype.setRetries=function(retries){this._retries=retries};GROK.ApiObject.prototype.getRetries=function(){return this._retries};GROK.ApiObject.prototype.setUserId=function(userId){this._userId=userId};GROK.ApiObject.prototype.getUserId=function(){return this._userId};GROK.ApiObject.prototype.setApiKey=function(apiKey){this._apiKey=apiKey};GROK.ApiObject.prototype.getApiKey=function(){return this._apiKey};GROK.ApiObject.prototype.setHeaders=function(headers){this._httpHeaders=headers||{}};GROK.ApiObject.prototype.getHeaders=function(){return this._httpHeaders};GROK.ApiObject.prototype.expand=function(ApiSubclass,fn){GROK.debug("ApiObject.expand for "+this.constructor.NAMESPACE);var me=this,namespace=ApiSubclass.NAMESPACE,singularNamespace=namespace.substr(0,namespace.length-1),apiPath=this.get("url");GROK.debug("Expanding "+singularNamespace);this.makeRequest({method:"GET",url:apiPath,success:function(details){var data=details[singularNamespace];me.setDetails(data);fn(null,me.getDetails())},failure:function(err){fn(err)}})};GROK.ApiObject.prototype["delete"]=function(callback){GROK.debug("ApiObject.delete for "+this.constructor.NAMESPACE);var me=this;this.makeRequest({method:"DELETE",url:this.get("url"),success:function(){var name;for(name in me){delete me[name]}callback()},failure:function(err){callback(err)}})};GROK.ApiObject.prototype.makeRequest=function(options){GROK.info("GROK.ApiObject.makeRequest for "+this.constructor.NAMESPACE);GROK.debug(options);var name,error,timeout=this.getTimeout(),maxRetries=this.getRetries(),instanceHeaders=GROK.util.shallowObjectClone(this._httpHeaders),sendOptions,requestDetails,grokRequest;if(!options.url&&!options.path){error=new Error("Cannot make request without an absolute "+'"url" or relative "path".');if(options.failure){options.failure(error);return}else{throw error}}if(!options.headers){options.headers=instanceHeaders}else{for(name in instanceHeaders){if(!options.headers[name]){options.headers[name]=instanceHeaders[name]}}}if(!GROK.util.isSet(options.forceProxy)){options.forceProxy=GROK.ApiObject.FORCE_PROXY}grokRequest=new global.GROK.Request({endpoint:this.getEndpoint(),version:this.getVersion(),apiKey:this.getApiKey(),proxyEndpoint:this.getProxyEndpoint()});function constructRequestOptions(options,requestDetails){var requestOptions={};Object.keys(options).forEach(function(optionKey){requestOptions[optionKey]=options[optionKey]});requestOptions.success=callbackWrapper(options.success,requestDetails);requestOptions.failure=callbackWrapper(options.failure,requestDetails);return requestOptions}function callbackWrapper(originalFunction,requestTracker){return function(result,status,headers){var error,requestId=requestTracker.id,requestOptions=requestTracker.options;if(result instanceof Error){result.statusCode=status}if(requestTracker.status===REQUEST_STATUS.TIMEOUT){if(requestTracker.retries<maxRetries){clearTimeout(requestTracker);requestTracker.status=REQUEST_STATUS.SENT;requestTracker.retries++;GROK.debug("GROK.ApiObject.makeRequest: resent "+requestId+" ("+requestTracker.retries+" times)");startTimeout(requestTracker,timeout);requestTracker.request.send(constructRequestOptions(requestOptions,requestTracker))}else{error=new Error('API call to "'+(requestOptions.url||requestOptions.path)+'" timed out after '+timeout+"ms and "+requestTracker.retries+" retries.");if(requestOptions.failure){requestOptions.failure(error)}else{throw error}}}else if(status===503&&headers&&headers["Retry-After"]){clearTimeout(requestTracker);setTimeout(function(){startTimeout(requestTracker,timeout);requestTracker.request.send(constructRequestOptions(requestOptions,requestTracker))},headers["Retry-After"]*1e3)}else{clearTimeout(requestTracker);if(originalFunction){originalFunction.apply(this,arguments)}}}}function clearTimeout(requestTracker){clearInterval(requestTracker.timeoutInterval);delete requestTracker.timeoutInterval}function startTimeout(requestTracker,localTimeout){if(localTimeout>0){GROK.debug("GROK.ApiObject.makeRequest: starting "+localTimeout+"ms timeout for request "+requestTracker.id);requestTracker.timeoutInterval=setTimeout(function(){GROK.debug("GROK.ApiObject.makeRequest: request "+requestTracker.id+"("+requestTracker.status+") timed out");requestTracker.status=REQUEST_STATUS.TIMEOUT},localTimeout)}}requestDetails={id:this._requestIncrement++,request:grokRequest,retries:0,options:options,status:REQUEST_STATUS.SENT};startTimeout(requestDetails,timeout);sendOptions=constructRequestOptions(options,requestDetails);grokRequest.send(sendOptions)};GROK.ApiObject.prototype.setScalar=function(key,value){this._scalars[key]=value};GROK.ApiObject.prototype.setScalars=function(scalars,clobber){this._scalars=merge(scalars,this._scalars,clobber)};GROK.ApiObject.prototype.getScalars=function(){return this._scalars||{}};GROK.ApiObject.prototype.getScalar=function(name){return this._scalars[name]};GROK.ApiObject.prototype.setDetails=function(details,clobber){this._details=merge(details,this._details,clobber)};GROK.ApiObject.prototype.setDetail=function(name,value){this._details[name]=value};GROK.ApiObject.prototype.getDetails=function(){return this._details||{}};GROK.ApiObject.prototype.getDetail=function(name){return this._details[name]};GROK.ApiObject.prototype.hasDetails=function(){return GROK.util.isSet(this._details)};GROK.ApiObject.prototype.populate=function(callback){this.expand(this.constructor,callback)};GROK.ApiObject.prototype.update=function(props,callback){this.updateObject(this.constructor,props,callback)};GROK.ApiObject.prototype.listObjects=function(){GROK.debug("GROK.ApiObject.listObjects for "+this.constructor.NAMESPACE);var ApiSubclass=arguments[0],data=typeof arguments[1]==="function"?{}:arguments[1],callback=typeof arguments[1]==="function"?arguments[1]:arguments[2],me=this,subclassNamespace=ApiSubclass.NAMESPACE,apiPath=this.get(subclassNamespace+"Url");this.makeRequest({method:"GET",url:apiPath,data:data,success:function(resp){var i=0,objects=resp[subclassNamespace];for(;i<objects.length;i++){objects[i]=new ApiSubclass(objects[i],me._getDefaultChildOptions());objects[i].setScalar("_parent",me)}callback(null,objects)},failure:function(error){callback(error)}})};GROK.ApiObject.prototype.createObject=function(ApiSubclass,objectProperties,callback){GROK.debug("GROK.ApiObject.createObject for "+this.constructor.NAMESPACE);var me=this,namespace=ApiSubclass.NAMESPACE,singularNamespace=namespace.substr(0,namespace.length-1),data={};data[singularNamespace]=objectProperties;this.makeRequest({method:"POST",url:this.get(namespace+"Url"),data:data,success:function(resp){var newObject=new ApiSubclass(resp[singularNamespace],me._getDefaultChildOptions());newObject.setScalar("_parent",me);callback(null,newObject)},failure:function(error){callback(error)}})};GROK.ApiObject.prototype.getObject=function(ApiSubclass,id,callback){GROK.debug("GROK.ApiObject.getObject for "+this.constructor.NAMESPACE);var me=this,namespace=ApiSubclass.NAMESPACE,singularNamespace=namespace.substr(0,namespace.length-1);this.makeRequest({method:"GET",url:this.get(namespace+"Url")+"/"+id,success:function(responseData,responseText){var childOptions=me._getDefaultChildOptions();childOptions.rawJSON=responseText;callback(null,new ApiSubclass(responseData[singularNamespace],childOptions))},failure:function(error){callback(error)}})};GROK.ApiObject.prototype.updateObject=function(ApiSubclass,updatedProps,callback){GROK.debug("GROK.ApiObject.updateObject for "+this.constructor.NAMESPACE);var me=this,name,namespace=ApiSubclass.NAMESPACE,singularNamespace=namespace.substr(0,namespace.length-1),updateObject,fullUpdate={};updateObject=me.getAttrs();for(name in updatedProps){if(updatedProps.hasOwnProperty(name)){updateObject[name]=updatedProps[name]}}fullUpdate[singularNamespace]=updateObject;this.makeRequest({method:"POST",url:this.get("url"),data:fullUpdate,success:function(){me.setDetails(updateObject,false);me.setScalars(updateObject,false);callback()},failure:function(error){callback(error)}})};GROK.ApiObject.prototype._getDefaultChildOptions=function(){return{endpoint:this.getEndpoint(),proxyEndpoint:this.getProxyEndpoint(),version:this.getVersion(),headers:this.getHeaders(),userId:this.getUserId(),apiKey:this.getApiKey()}};GROK.ApiObject.prototype.toJSON=function(){var args=[this.getAttrs()].concat(Array.prototype.slice.call(arguments));return JSON.stringify.apply(JSON,args)}})(window);