/*
 * ----------------------------------------------------------------------
 *  Copyright (C) 2006-2012 Numenta Inc. All rights reserved.
 *
 *  The information and source code contained herein is the
 *  exclusive property of Numenta Inc. No part of this software
 *  may be used, reproduced, stored or distributed in any form,
 *  without explicit written authorization from Numenta Inc.
 * ---------------------------------------------------------------------- */(function(a){function e(a,b,c){var d;return Array.prototype.some.call(a,function(a,e,f){if(b.call(c,a,e,f))return d=e,!0}),d}function f(a,b){b=b||{},this._poller=a,this._interval=b.interval||c,this._debug=b.debug,this._pollIntervalId=-1,this._pollListeners=[],this._doneListeners=[],this._errorListeners=[],this._done=!1}function g(a,b){this._swarm=a,this._lastStatus=undefined,this._statusChangeListeners=[],f.call(this,this._swarmPoller,b)}function h(a,b){b=b||{},b.interval=b.interval||1e3,this._limit=b.limit||100,this._repeatTimes=b.repeatTimes||15,this._model=a,this._dataListeners=[],this._lastRowSeen=b.lastRowIdSeen||-1,this._doneCounter=0,f.call(this,this._outputPoller,b)}var b=a.GROK,c=2e3,d="any";f.prototype.onPoll=function(a){return this._pollListeners.push(a),this},f.prototype.onDone=function(a){return this._doneListeners.push(a),this},f.prototype.onError=function(a){return this._errorListeners.push(a),this},f.prototype._fire=function(a,b){this._print("Monitor calling "+a+" listeners"),a==="done"&&(this._done=!0),this["_"+a+"Listeners"].forEach(function(a){a(b)})},f.prototype.start=function(){var a=this,b=!1;return this._startTime=(new Date).getTime(),this._print("Monitor starting"),this._pollIntervalId=setInterval(function(){if(b)return;b=!0,a._print("Monitor polling..."),a._poller(function(c){a._print("Monitor received poll result: "),a._done||a._fire("poll",c),b=!1})},this._interval),this},f.prototype.stop=function(){var a=(new Date).getTime()-this._startTime;return this._print("Monitor stopping"),clearInterval(this._pollIntervalId),this._fire("done",a),a},f.prototype._print=function(a){this._debug&&console.log(a)},g.prototype=b.util.heir(f.prototype),g.prototype.constructor=f,g.prototype._swarmPoller=function(a){var b=this;this._print("polling for swarm..."),this._swarm.getStatus(function(c,d){if(c)return b._fire("error",c);var e=d.get("status");b._lastStatus&&e!==b._lastStatus&&b.statusChange(d),b._lastStatus=e,a(d)})},g.prototype.onStatusChange=function(a){this._statusChangeListeners.push({trigger:d,fn:a})},g.prototype.onStatus=function(a,b){this._statusChangeListeners.push({trigger:a,fn:b})},g.prototype.statusChange=function(a){this._print("SwarmMonitor calling statusChange listeners"),this._statusChangeListeners.forEach(function(b){var c=b.trigger,e=b.fn;(c===d||c===a.get("status"))&&e(a)})},h.prototype=b.util.heir(f.prototype),h.prototype.constructor=f,h.prototype._outputPoller=function(a){var b=this;this._print("polling for new model output..."),this._model.getOutputData({limit:b._limit},function(c,d){if(c)return b._fire("error",c);d.data=b._processOutputData(d.data),b._data(d),a(d)})},h.prototype.onData=function(a){this._dataListeners.push(a)},h.prototype._data=function(a){this._dataListeners.forEach(function(b){b(a)})},h.prototype._processOutputData=function(a){var b=this,c,d,f=a[0][0],g=a[a.length-1][0];return this._lastRowSeen===-1?d=a:f<this._lastRowSeen?(c=e(a,function(a){return a[0]===b._lastRowSeen+1}),d=a.slice(c)):f+1===this._lastRowSeen?d=a:(b._fire("error",new Error("There was a data gap while retrieving predictions from the API.")),d=a),this._lastRowSeen===g&&(this._doneCounter>this._repeatTimes?this.stop():this._doneCounter++),this._lastRowSeen=g,d},b.SwarmMonitor=g,b.PredictionMonitor=h})(window);