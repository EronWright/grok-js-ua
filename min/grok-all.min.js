
(function(global){global.GROK={}})(window);(function(global){global.GROK.util={toUriParams:function(data){var s="",key;for(key in data){if(data.hasOwnProperty(key)){s+=key+"="+encodeURIComponent(data[key])+"&"}}s=s.substr(0,s.length-1);return s},isSet:function(thing){return thing!==undefined&&thing!==null},shallowObjectClone:function(obj){return JSON.parse(JSON.stringify(obj))},heir:function(p){function F(){}F.prototype=p;return new F}};global.GROK.LOG={ALL:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,NONE:5};global.GROK.LOG_LEVEL=global.GROK.LOG.ERROR;global.GROK.log=function(msg){if(this.LOG_LEVEL<=this.LOG.ALL){console.log(msg)}};global.GROK.debug=function(msg){if(this.LOG_LEVEL<=this.LOG.DEBUG){if(console.debug){console.debug(msg)}else{console.log(msg)}}};global.GROK.info=function(msg){if(this.LOG_LEVEL<=this.LOG.INFO){console.info(msg)}};global.GROK.warn=function(msg){if(this.LOG_LEVEL<=this.LOG.WARN){console.warn(msg)}};global.GROK.error=function(msg){if(this.LOG_LEVEL<=this.LOG.ERROR){console.error(msg)}}})(window);(function(global){var GROK=global.GROK,DEFAULT_XHR_METHOD="POST",DEFAULT_XHR_ENDPOINT="/grok",DEFAULT_XHR_HEADER="x-grok";function sendJsonpRequest(jxhr,url,opts){var myUrl=url+"?";jxhr.onerror=opts.failure;jxhr.onreadystatechange=function(data){if(jxhr.readyState===4){if(data.error&&opts.failure){opts.failure(new Error(data.error))}opts.success(JSON.parse(data))}};if(opts.data){myUrl+=GROK.util.toUriParams(opts.data)+"&callback=?"}else{myUrl+="callback=?"}jxhr.open(null,myUrl);jxhr.send()}function sendXhr(url,method,opts){var bundle,name,xhr=this._xhr,proxyEndpoint=this._proxyEndpoint||DEFAULT_XHR_ENDPOINT,apiKey=this._apiKey;opts.failure=opts.failure||function(){};xhr.open(DEFAULT_XHR_METHOD,proxyEndpoint);xhr.setRequestHeader("Content-Type","application/json;charset=UTF-8");xhr.setRequestHeader(DEFAULT_XHR_HEADER,"1");for(name in opts.headers){if(opts.headers.hasOwnProperty(name)){xhr.setRequestHeader(name,opts.headers[name])}}xhr.onreadystatechange=function(){var responseData,rawRespHeaders,respHeaders={};if(this.readyState==4&&this.status==200){if(opts.success){if(this.responseText){try{responseData=JSON.parse(this.responseText)}catch(e){responseData={errors:["Could not parse "+"response text from API server: "+this.responseText]}}if(responseData.errors){opts.failure(new Error(responseData.errors[0]))}else{opts.success(responseData,this.responseText)}}else{opts.success()}}}else if(this.readyState==4&&this.status!==0){if(opts.failure){rawRespHeaders=this.getAllResponseHeaders();if(rawRespHeaders){rawRespHeaders.split("\n").forEach(function(line){var parts=line.split(":"),value=parts[1].trim();if(!isNaN(parseFloat(value))&&isFinite(value)){value=new Number(value)}respHeaders[parts[0]]=value})}opts.failure(new Error("There was an XHR error, status is: "+this.status),parseInt(this.status),respHeaders)}}};bundle={proxy:{method:method,endpoint:url}};if(apiKey){bundle.apiKey=apiKey}if(opts.data){bundle.proxy.data=opts.data}xhr.send(JSON.stringify(bundle))}function shouldUseJsonp(httpMethod,opts){if(opts.forceProxy){return false}return httpMethod==="GET"}GROK.Request=function(options){var endpoint=options.endpoint,version=options.version,apiKey=options.apiKey,proxyEndpoint=options.proxyEndpoint,join="";if(!endpoint||!version){throw new Error("Cannot create GROK.Request object without "+"endpoint and version: \"new GROK.Request('/endpoint', "+"'version'\"")}this._apiKey=apiKey;this._proxyEndpoint=proxyEndpoint;this._xhr=new XMLHttpRequest;this._jxhr=new global.jXHR;if(endpoint.substr(endpoint.length-1,1)!=="/"){join="/"}this._root=endpoint+join+version;this.constructor=GROK.Request};GROK.Request.prototype.send=function(options){var httpMethod=options.method||"GET",url=options.url||this._root+"/"+options.path;httpMethod=httpMethod.toUpperCase();if(shouldUseJsonp(httpMethod,options)){sendJsonpRequest(this._jxhr,url,options)}else{sendXhr.call(this,url,httpMethod,options)}}})(window);(function(global){var GROK=global.GROK,DEFAULT={ENDPOINT:"https://api.groksolutions.com/",VERSION:"v2",FORCE_PROXY:true,TIMEOUT:3e4,RETRIES:2},REQUEST_STATUS={SENT:1,TIMEOUT:2};function merge(from,to,clobber){var name;if(!to){return from}if(typeof clobber==="undefined"){clobber=true}if(clobber){to=from}else{for(name in from){to[name]=from[name]}}return to}GROK.ApiObject=function(scalars,options){options=options||{};scalars=scalars||{};this.setScalars(scalars);this.setDetails({});this.setEndpoint(options.endpoint||DEFAULT.ENDPOINT);this.setProxyEndpoint(options.proxyEndpoint);this.setVersion(options.version||DEFAULT.VERSION);this.setTimeout(typeof options.timeout!=="undefined"?options.timeout:DEFAULT.TIMEOUT);this.setRetries(typeof options.retries!=="undefined"?options.retries:DEFAULT.RETRIES);this.setHeaders(options.httpHeaders||{});this.setUserId(options.userId);this.setApiKey(options.apiKey);this.rawJSON=options.rawJSON;this._requests={};this._requestIncrement=0};GROK.ApiObject.FORCE_PROXY=DEFAULT.FORCE_PROXY;GROK.ApiObject.prototype.getAttrs=function(){var s=this._scalars,d=this._details,out={},name;for(name in s){if(s.hasOwnProperty(name)&&name.indexOf("_")!==0){out[name]=s[name]}}for(name in d){if(d.hasOwnProperty(name)&&name.indexOf("_")!==0){out[name]=d[name]}}return out};GROK.ApiObject.prototype.getAttr=function(name){return this.get(name)};GROK.ApiObject.prototype.get=function(name){var result=this._scalars[name];if(!result&&this._details){result=this._details[name]}return result};GROK.ApiObject.prototype.getId=function(){return this.get("id")};GROK.ApiObject.prototype.setEndpoint=function(endpoint){this._apiEndpoint=endpoint};GROK.ApiObject.prototype.setProxyEndpoint=function(endpoint){this._proxyEndpoint=endpoint};GROK.ApiObject.prototype.getProxyEndpoint=function(){return this._proxyEndpoint};GROK.ApiObject.prototype.getEndpoint=function(){return this._apiEndpoint};GROK.ApiObject.prototype.setVersion=function(version){this._apiVersion=version};GROK.ApiObject.prototype.getVersion=function(){return this._apiVersion};GROK.ApiObject.prototype.setTimeout=function(timeout){this._timeout=timeout};GROK.ApiObject.prototype.getTimeout=function(){return this._timeout};GROK.ApiObject.prototype.setRetries=function(retries){this._retries=retries};GROK.ApiObject.prototype.getRetries=function(){return this._retries};GROK.ApiObject.prototype.setUserId=function(userId){this._userId=userId};GROK.ApiObject.prototype.getUserId=function(){return this._userId};GROK.ApiObject.prototype.setApiKey=function(apiKey){this._apiKey=apiKey};GROK.ApiObject.prototype.getApiKey=function(){return this._apiKey};GROK.ApiObject.prototype.setHeaders=function(headers){this._httpHeaders=headers||{}};GROK.ApiObject.prototype.getHeaders=function(){return this._httpHeaders};GROK.ApiObject.prototype.expand=function(ApiSubclass,fn){GROK.debug("ApiObject.expand for "+this.constructor.NAMESPACE);var me=this,namespace=ApiSubclass.NAMESPACE,singularNamespace=namespace.substr(0,namespace.length-1),apiPath=this.get("url");GROK.debug("Expanding "+singularNamespace);this.makeRequest({method:"GET",url:apiPath,success:function(details){var data=details[singularNamespace];me.setDetails(data);fn(null,me.getDetails())},failure:function(err){fn(err)}})};GROK.ApiObject.prototype["delete"]=function(callback){GROK.debug("ApiObject.delete for "+this.constructor.NAMESPACE);var me=this;this.makeRequest({method:"DELETE",url:this.get("url"),success:function(){var name;for(name in me){delete me[name]}callback()},failure:function(err){callback(err)}})};GROK.ApiObject.prototype.makeRequest=function(options){GROK.info("GROK.ApiObject.makeRequest for "+this.constructor.NAMESPACE);GROK.debug(options);var name,error,timeout=this.getTimeout(),maxRetries=this.getRetries(),instanceHeaders=GROK.util.shallowObjectClone(this._httpHeaders),sendOptions,requestDetails,grokRequest;if(!options.url&&!options.path){error=new Error("Cannot make request without an absolute "+'"url" or relative "path".');if(options.failure){options.failure(error);return}else{throw error}}if(!options.headers){options.headers=instanceHeaders}else{for(name in instanceHeaders){if(!options.headers[name]){options.headers[name]=instanceHeaders[name]}}}if(!GROK.util.isSet(options.forceProxy)){options.forceProxy=GROK.ApiObject.FORCE_PROXY}grokRequest=new global.GROK.Request({endpoint:this.getEndpoint(),version:this.getVersion(),apiKey:this.getApiKey(),proxyEndpoint:this.getProxyEndpoint()});function constructRequestOptions(options,requestDetails){var requestOptions={};Object.keys(options).forEach(function(optionKey){requestOptions[optionKey]=options[optionKey]});requestOptions.success=callbackWrapper(options.success,requestDetails);requestOptions.failure=callbackWrapper(options.failure,requestDetails);return requestOptions}function callbackWrapper(originalFunction,requestTracker){return function(result,status,headers){var error,requestId=requestTracker.id,requestOptions=requestTracker.options;if(result instanceof Error){result.statusCode=status}if(requestTracker.status===REQUEST_STATUS.TIMEOUT){if(requestTracker.retries<maxRetries){clearTimeout(requestTracker);requestTracker.status=REQUEST_STATUS.SENT;requestTracker.retries++;GROK.debug("GROK.ApiObject.makeRequest: resent "+requestId+" ("+requestTracker.retries+" times)");startTimeout(requestTracker,timeout);requestTracker.request.send(constructRequestOptions(requestOptions,requestTracker))}else{error=new Error('API call to "'+(requestOptions.url||requestOptions.path)+'" timed out after '+timeout+"ms and "+requestTracker.retries+" retries.");if(requestOptions.failure){requestOptions.failure(error)}else{throw error}}}else if(status===503&&headers&&headers["Retry-After"]){clearTimeout(requestTracker);setTimeout(function(){startTimeout(requestTracker,timeout);requestTracker.request.send(constructRequestOptions(requestOptions,requestTracker))},headers["Retry-After"]*1e3)}else{clearTimeout(requestTracker);if(originalFunction){originalFunction.apply(this,arguments)}}}}function clearTimeout(requestTracker){clearInterval(requestTracker.timeoutInterval);delete requestTracker.timeoutInterval}function startTimeout(requestTracker,localTimeout){if(localTimeout>0){GROK.debug("GROK.ApiObject.makeRequest: starting "+localTimeout+"ms timeout for request "+requestTracker.id);requestTracker.timeoutInterval=setTimeout(function(){GROK.debug("GROK.ApiObject.makeRequest: request "+requestTracker.id+"("+requestTracker.status+") timed out");requestTracker.status=REQUEST_STATUS.TIMEOUT},localTimeout)}}requestDetails={id:this._requestIncrement++,request:grokRequest,retries:0,options:options,status:REQUEST_STATUS.SENT};startTimeout(requestDetails,timeout);sendOptions=constructRequestOptions(options,requestDetails);grokRequest.send(sendOptions)};GROK.ApiObject.prototype.setScalar=function(key,value){this._scalars[key]=value};GROK.ApiObject.prototype.setScalars=function(scalars,clobber){this._scalars=merge(scalars,this._scalars,clobber)};GROK.ApiObject.prototype.getScalars=function(){return this._scalars||{}};GROK.ApiObject.prototype.getScalar=function(name){return this._scalars[name]};GROK.ApiObject.prototype.setDetails=function(details,clobber){this._details=merge(details,this._details,clobber)};GROK.ApiObject.prototype.setDetail=function(name,value){this._details[name]=value};GROK.ApiObject.prototype.getDetails=function(){return this._details||{}};GROK.ApiObject.prototype.getDetail=function(name){return this._details[name]};GROK.ApiObject.prototype.hasDetails=function(){return GROK.util.isSet(this._details)};GROK.ApiObject.prototype.populate=function(callback){this.expand(this.constructor,callback)};GROK.ApiObject.prototype.update=function(props,callback){this.updateObject(this.constructor,props,callback)};GROK.ApiObject.prototype.listObjects=function(){GROK.debug("GROK.ApiObject.listObjects for "+this.constructor.NAMESPACE);var ApiSubclass=arguments[0],data=typeof arguments[1]==="function"?{}:arguments[1],callback=typeof arguments[1]==="function"?arguments[1]:arguments[2],me=this,subclassNamespace=ApiSubclass.NAMESPACE,apiPath=this.get(subclassNamespace+"Url");this.makeRequest({method:"GET",url:apiPath,data:data,success:function(resp){var i=0,objects=resp[subclassNamespace];for(;i<objects.length;i++){objects[i]=new ApiSubclass(objects[i],me._getDefaultChildOptions());objects[i].setScalar("_parent",me)}callback(null,objects)},failure:function(error){callback(error)}})};GROK.ApiObject.prototype.createObject=function(ApiSubclass,objectProperties,callback){GROK.debug("GROK.ApiObject.createObject for "+this.constructor.NAMESPACE);var me=this,namespace=ApiSubclass.NAMESPACE,singularNamespace=namespace.substr(0,namespace.length-1),data={};data[singularNamespace]=objectProperties;this.makeRequest({method:"POST",url:this.get(namespace+"Url"),data:data,success:function(resp){var newObject=new ApiSubclass(resp[singularNamespace],me._getDefaultChildOptions());newObject.setScalar("_parent",me);callback(null,newObject)},failure:function(error){callback(error)}})};GROK.ApiObject.prototype.getObject=function(ApiSubclass,id,callback){GROK.debug("GROK.ApiObject.getObject for "+this.constructor.NAMESPACE);var me=this,namespace=ApiSubclass.NAMESPACE,singularNamespace=namespace.substr(0,namespace.length-1);this.makeRequest({method:"GET",url:this.get(namespace+"Url")+"/"+id,success:function(responseData,responseText){var childOptions=me._getDefaultChildOptions();childOptions.rawJSON=responseText;callback(null,new ApiSubclass(responseData[singularNamespace],childOptions))},failure:function(error){callback(error)}})};GROK.ApiObject.prototype.updateObject=function(ApiSubclass,updatedProps,callback){GROK.debug("GROK.ApiObject.updateObject for "+this.constructor.NAMESPACE);var me=this,name,namespace=ApiSubclass.NAMESPACE,singularNamespace=namespace.substr(0,namespace.length-1),updateObject,fullUpdate={};updateObject=me.getAttrs();for(name in updatedProps){if(updatedProps.hasOwnProperty(name)){updateObject[name]=updatedProps[name]}}fullUpdate[singularNamespace]=updateObject;this.makeRequest({method:"POST",url:this.get("url"),data:fullUpdate,success:function(){me.setDetails(updateObject,false);me.setScalars(updateObject,false);callback()},failure:function(error){callback(error)}})};GROK.ApiObject.prototype._getDefaultChildOptions=function(){return{endpoint:this.getEndpoint(),proxyEndpoint:this.getProxyEndpoint(),version:this.getVersion(),headers:this.getHeaders(),userId:this.getUserId(),apiKey:this.getApiKey()}};GROK.ApiObject.prototype.toJSON=function(){var args=[this.getAttrs()].concat(Array.prototype.slice.call(arguments));return JSON.stringify.apply(JSON,args)}})(window);(function(global){var GROK=global.GROK;GROK.Stream=function(attrs,options){GROK.ApiObject.apply(this,arguments);this.constructor=GROK.Stream};GROK.Stream.prototype=GROK.util.heir(GROK.ApiObject.prototype);GROK.Stream.prototype.constructor=GROK.ApiObject;GROK.Stream.NAMESPACE="streams";GROK.Stream.AGGREGATION={RECORD:"record",SECONDS:"seconds",MINUTES:"minutes",MINUTES_15:"minutes15",HOURS:"hours",DAYS:"days",WEEKS:"weeks",MONTHS:"months"};GROK.Stream.DATATYPE={DATETIME:"DATETIME",CATEGORY:"CATEGORY",SCALAR:"SCALAR"};GROK.Stream.DATAFLAG={TIMESTAMP:"TIMESTAMP",LOCATION:"LOCATION"};GROK.Stream.AGGREGATION_FUNCTION={FIRST:"first",LAST:"last",AVERAGE:"average",SUM:"sum",MAX:"max",MIN:"min"};GROK.Stream.PREDICTION_TYPE={TEMPORAL:"temporal",SPATIAL:"spatial"};GROK.Stream.HOLIDAY_LOCALE={US_HOLIDAYS:"US-HOLIDAYS",UK_HOLIDAYS:"UK-HOLIDAYS",CA_HOLIDAYS:"CA-HOLIDAYS"};GROK.Stream.prototype.addData=function(rawData,callback){this.makeRequest({method:"POST",url:this.get("dataUrl"),data:{input:rawData},success:function(){callback()},failure:function(err){callback(err)}})};GROK.Stream.prototype.getInputData=function(callback){this.makeRequest({method:"GET",url:this.get("dataUrl"),success:function(resp){if(!resp.input){callback(new Error("malformed API response! "+'Expected "input" key.'))}else{callback(null,resp.input)}},failure:function(err){callback(err)}})}})(window);(function(global){var GROK=global.GROK,DEFAULT_SWARM_MONITOR_INTERVAL=1e3,DEFAULT_PROMOTION_INTERVAL=500;GROK.Model=function(attrs,options){options=options||{};if(options.promotionInterval===undefined){this.promotionInterval=DEFAULT_PROMOTION_INTERVAL}GROK.ApiObject.apply(this,arguments);this.constructor=GROK.Model};GROK.Model.prototype=GROK.util.heir(GROK.ApiObject.prototype);GROK.Model.prototype.constructor=GROK.ApiObject;GROK.Model.NAMESPACE="models";GROK.Model.prototype.getName=function(){return this.getAttr("name")};GROK.Model.prototype.clone=function(callback){var me=this,parent=this.getScalar("_parent");if(!this.hasDetails()){this.populate(function(err){if(err){callback(err)}else{parent.createModel(me.getAttrs(),callback)}})}else{parent.createModel(me.getAttrs(),callback)}};GROK.Model.prototype.getStream=function(callback){var streamId=this.get("streamId"),parent=this.get("_parent");parent.getStream(streamId,callback)};GROK.Model.prototype.getOutputData=function(opts,callback){var me=this,cb,limit,shift;if(typeof opts==="function"){cb=opts}else{limit=opts.limit||1e3;shift=opts.shift||false;cb=callback}this.makeRequest({data:{limit:limit,shift:shift},url:this.get("dataUrl"),success:function(data){var output=data.output||{data:[],names:[],meta:{}};cb(null,output)},failure:function(err){cb(err)}})};GROK.Model.prototype.monitorPredictions=function(opts){var monitor;opts=opts||{};opts.interval=opts.interval||1e3;opts.timeout=opts.timeout||30;monitor=new GROK.PredictionMonitor(this,{debug:opts.debug,interval:opts.interval,outputDataOptions:opts.outputDataOptions,timeout:opts.timeout,lastRowIdSeen:opts.startAt});if(opts.onUpdate){monitor.onData(opts.onUpdate)}if(opts.onDone){monitor.onDone(opts.onDone)}if(opts.onError){monitor.onError(opts.onError)}monitor.start();return monitor};GROK.Model.prototype.listSwarms=function(callback){this.makeRequest({method:"GET",url:this.get("swarmsUrl"),success:function(data){callback(null,data.swarms)},failure:function(err){callback(err)}})};GROK.Model.prototype.startSwarm=function(opts,callback){var me=this,cb,size,interval,debug;if(typeof opts==="function"){cb=opts}else{size=opts.size||GROK.Swarm.SIZE.MEDIUM;interval=opts.interval||DEFAULT_SWARM_MONITOR_INTERVAL;debug=opts.debug;cb=callback}this.makeRequest({method:"POST",data:{options:{size:size}},url:this.get("swarmsUrl"),success:function(data,respText){var swarmAttrs=data.swarm,swarm=new GROK.Swarm(swarmAttrs,{rawJSON:respText});swarmAttrs._parent=me;cb(null,swarm,new GROK.SwarmMonitor(swarm,{interval:interval,debug:debug}))},failure:function(err){cb(err)}})};GROK.Model.prototype.stopSwarm=function(callback){var me=this;this.makeRequest({method:"POST",url:this.get("commandsUrl"),data:{command:"stop"},success:function(){me.setScalar("status",GROK.Swarm.STOPPED);callback()},failure:function(err){callback(err)}})};GROK.Model.prototype.start=function(callback){var me=this;this.makeRequest({method:"POST",url:this.get("commandsUrl"),data:{command:"start"},success:function(){me.setScalar("status",GROK.Swarm.RUNNING);callback()},failure:function(err){callback(err)}})};GROK.Model.prototype.getSwarm=function(swarmId,callback){this.makeRequest({method:"GET",url:this.get("swarmsUrl")+"/"+swarmId,success:function(data,respText){callback(null,new GROK.Swarm(data.swarm,{rawJSON:respText}))},failure:function(err){callback(err)}})};GROK.Model.prototype.listCheckpoints=function(callback){this.makeRequest({method:"GET",url:this.get("checkpointsUrl"),success:function(data){callback(null,data.checkpoints)},failure:function(err){callback(err)}})};GROK.Model.prototype.createCheckpoint=function(callback){this.makeRequest({method:"POST",url:this.get("checkpointsUrl"),success:function(data){callback(null,data.checkpoint)},failure:function(err){callback(err)}})};GROK.Model.prototype.promote=function(callback){var me=this,callbackCalled,initialOutputLength;function whenRunning(){var passedCacheInterval=setInterval(function(){me.getOutputData(function(err,outputData){if(err){return callback(err)}if(!callbackCalled&&outputData.data.length>=initialOutputLength){clearInterval(passedCacheInterval);callback();callbackCalled=true}})},me.promotionInterval)}function afterPromotion(){me.getOutputData(function(err,outputData){var runningInterval;if(err){return callback(err)}initialOutputLength=outputData.data.length;runningInterval=setInterval(function(){me.populate(function(err,modelDetails){if(err){return callback(err)}if(modelDetails.status==="running"&&runningInterval){clearInterval(runningInterval);runningInterval=null;whenRunning()}})},me.promotionInterval)})}this.makeRequest({method:"POST",url:this.get("commandsUrl"),data:{command:"promote"},success:function(){afterPromotion()},failure:function(err){callback(err)}})}})(window);(function(global){var GROK=global.GROK;GROK.Swarm=function(attrs,options){GROK.ApiObject.apply(this,arguments);this.constructor=GROK.Swarm};GROK.Swarm.prototype=GROK.util.heir(GROK.ApiObject.prototype);GROK.Swarm.prototype.constructor=GROK.ApiObject;GROK.Swarm.NAMESPACE="swarms";GROK.Swarm.STATUS={STOPPED:"stopped",COMPLETED:"completed",CANCELLED:"cancelled",NOT_STARTED:"not_started",RUNNING:"running",SWARMING:"swarming",ERROR:"error"};GROK.Swarm.SIZE={SMALL:"small",MEDIUM:"medium",LARGE:"large"};GROK.Swarm.prototype.getStatus=function(callback){var parent=this.getScalar("_parent");parent.getSwarm(this.getId(),callback)}})(window);(function(global){var GROK=global.GROK;GROK.Project=function(scalars,options){GROK.ApiObject.apply(this,arguments);this.constructor=GROK.Project};GROK.Project.prototype=GROK.util.heir(GROK.ApiObject.prototype);GROK.Project.prototype.constructor=GROK.ApiObject;GROK.Project.NAMESPACE="projects";GROK.Project.prototype.getName=function(){return this.getScalar("name")};GROK.Project.prototype.getDescription=function(callback){var me=this,existingDescription=this.getAttr("description");if(existingDescription){callback(null,existingDescription)}else{this.populate(function(err){if(err){callback(err)}else{callback(null,me.getDetail("description"))}})}};GROK.Project.prototype.setName=function(name,callback){this.update({name:name},callback)};GROK.Project.prototype.listModels=function(callback){this.listObjects(GROK.Model,callback)};GROK.Project.prototype.listStreams=function(callback){this.listObjects(GROK.Stream,callback)};GROK.Project.prototype.listActions=function(opts,callback){var cb,queryOptions={};if(typeof opts==="function"){cb=opts}else{queryOptions=opts;cb=callback}this.listObjects(GROK.Action,queryOptions,cb)};GROK.Project.prototype.createModel=function(model,callback){callback=callback||function(){};this.createObject(GROK.Model,model,callback)};GROK.Project.prototype.createAction=function(action,callback){callback=callback||function(){};this.createObject(GROK.Action,action,callback)};GROK.Project.prototype.getModel=function(id,callback){var me=this;this.getObject(GROK.Model,id,function(err,model){if(err){return callback(err)}model.setScalar("_parent",me);callback(null,model)})};GROK.Project.prototype.createStream=function(streamDef,callback){callback=callback||function(){};this.createObject(GROK.Stream,streamDef,callback)}})(window);(function(global){var GROK=global.GROK;GROK.Action=function(attrs,options){GROK.ApiObject.apply(this,arguments);this.constructor=GROK.Action};GROK.Action.prototype=GROK.util.heir(GROK.ApiObject.prototype);GROK.Action.prototype.constructor=GROK.ApiObject;GROK.Action.NAMESPACE="actions"})(window);(function(global){var GROK=global.GROK;GROK.Client=function(apiKey,options){this._validated=false;if(!GROK.util.isSet(apiKey)){throw new Error("Cannot create GROK Client without an API "+'Key:\nnew GROK.Client("my-api-key");')}options=options||{};options.apiKey=apiKey;GROK.ApiObject.call(this,{},options);if(options.user&&options.user.id){this.setScalars(options.user);this._validated=true}this.constructor=GROK.Client};GROK.Client.prototype=GROK.util.heir(GROK.ApiObject.prototype);GROK.Client.prototype.constructor=GROK.ApiObject;GROK.Client.NAMESPACE="users";GROK.Client.prototype.init=function(callback){GROK.info("Connecting to Grok...");var me=this;this.makeRequest({method:"GET",path:"users",success:function(resp){if(!resp||!resp.users){callback(new Error("Client cannot understand "+"response from API at "+me.getEndpoint()+". Are you sure this is the proper Grok API URL?"))}else{GROK.info("Connected to Grok.");me.setScalars(resp.users[0]);me._validated=true;callback(null)}},failure:function(error){if(error.message==="Unauthorized"){callback(new Error('Invalid API key: "'+me.getApiKey()+'"'))}else{callback(error)}}})};GROK.Client.prototype.isValidated=function(){return this._validated};GROK.Client.prototype.createProject=function(name,callback){callback=callback||function(){};this.createObject(GROK.Project,{name:name},callback)};GROK.Client.prototype.createModel=function(model,callback){callback=callback||function(){};this.createObject(GROK.Model,model,callback)};GROK.Client.prototype.createStream=function(streamDefinition,callback){callback=callback||function(){};this.createObject(GROK.Stream,streamDefinition,callback)};GROK.Client.prototype.getStream=function(id,callback){callback=callback||function(){};this.getObject(GROK.Stream,id,function(err,stream){if(err&&err.message==="Not Found"){err.message="Input stream '"+id+"' not found";callback(err)}else if(err){callback(err)}else{callback(null,stream)}})};GROK.Client.prototype.getProject=function(id,callback){this.getObject(GROK.Project,id,callback)};GROK.Client.prototype.getModel=function(id,callback){var me=this;this.getObject(GROK.Model,id,function(err,model){if(err){return callback(err)}model.setScalar("_parent",me);callback(null,model)})};GROK.Client.prototype.listProjects=function(callback){this.listObjects(GROK.Project,callback)};GROK.Client.prototype.listModels=function(callback){this.listObjects(GROK.Model,{all:true},callback)};GROK.Client.prototype.listStreams=function(callback){this.listObjects(GROK.Stream,callback)}})(window);(function(global){var GROK=global.GROK,DEFAULT_POLL_INTERVAL=[3e3,3e6],DEFAULT_TIMEOUT=60,DEFAULT_POLL_INCREMENT=function(i){return i*2},ROW_ID="ROWID",ANY="any";function findIndex(obj,iterator,context){var result;Array.prototype.some.call(obj,function(value,index,list){if(iterator.call(context,value,index,list)){result=index;return true}});return result}function extractLastRowId(output){return output.data[output.data.length-1][output.names.indexOf(ROW_ID)]}function Monitor(poller,opts){opts=opts||{};this._poller=poller;if(typeof opts.interval==="undefined"){this._interval=DEFAULT_POLL_INTERVAL}else if(typeof opts.interval==="number"){this._interval=[opts.interval,opts.interval*10]}else{this._interval=opts.interval}this._increment=opts.increment||DEFAULT_POLL_INCREMENT;this._timeout=opts.timeout||DEFAULT_TIMEOUT;this._currentInterval=this._interval[0];this._debug=opts.debug;this._pollIntervalId=-1;this._pollListeners=[];this._doneListeners=[];this._errorListeners=[];this._done=false}Monitor.prototype.onPoll=function(fn){this._pollListeners.push(fn);return this};Monitor.prototype.onDone=function(fn){this._doneListeners.push(fn);return this};Monitor.prototype.onError=function(fn){this._errorListeners.push(fn);return this};Monitor.prototype._fire=function(evt,payload){var count=0;if(evt==="done"){this._done=true}this["_"+evt+"Listeners"].forEach(function(listener){count++;listener(payload)});this._print("Monitor called "+count+" "+evt+" listeners")};Monitor.prototype.start=function(){this._startTime=(new Date).getTime();this._print("Monitor starting");this._pollAt(this._currentInterval);return this};Monitor.prototype._pollAt=function(interval){var me=this,activePoll=false;if(this._pollIntervalId){clearInterval(this._pollIntervalId)}me._print("Polling at "+interval);this._pollIntervalId=setInterval(function(){if(activePoll){return}if(me._done){clearInterval(me._pollIntervalId);return}activePoll=true;me._print("Monitor polling...");me._poller(function(pollResult,newDataReceived){me._print("Monitor received poll result");me._print("new data recieved? "+new Boolean(newDataReceived));if(!newDataReceived){if(me._currentInterval!==me._interval[1]){me._currentInterval=Math.min(me._increment(me._currentInterval),me._interval[1]);me._pollAt(me._currentInterval)}}else{if(me._currentInterval!==me._interval[0]){me._currentInterval=me._interval[0];me._print("Resetting poll interval to "+me._currentInterval);me._pollAt(me._currentInterval)}}if(!me._done){me._fire("poll",pollResult)}activePoll=false})},interval)};Monitor.prototype.stop=function(){var duration=(new Date).getTime()-this._startTime;this._print("Monitor stopping");clearInterval(this._pollIntervalId);this._fire("done",duration);return duration};Monitor.prototype._print=function(msg){if(this._debug){console.log(msg)}};function SwarmMonitor(swarm,opts){this._swarm=swarm;this._lastStatus=undefined;this._statusChangeListeners=[];Monitor.call(this,this._swarmPoller,opts)}SwarmMonitor.prototype=GROK.util.heir(Monitor.prototype);SwarmMonitor.prototype.constructor=Monitor;SwarmMonitor.prototype._swarmPoller=function(cb){var me=this;this._print("polling for swarm...");this._swarm.getStatus(function(err,swarm){if(err){return me._fire("error",err)}var status=swarm.get("status");me._print("swarm status: "+status);if(status!==me._lastStatus){me.statusChange(swarm)}me._lastStatus=status;cb(swarm);if(status===GROK.Swarm.STATUS.COMPLETED){me.stop()}})};SwarmMonitor.prototype.onStatusChange=function(fn){this._statusChangeListeners.push({trigger:ANY,fn:fn})};SwarmMonitor.prototype.onStatus=function(status,fn){this._statusChangeListeners.push({trigger:status,fn:fn})};SwarmMonitor.prototype.statusChange=function(swarm){this._print("SwarmMonitor calling statusChange listeners");this._statusChangeListeners.forEach(function(listener){var trigger=listener.trigger,fn=listener.fn;if(trigger===ANY||trigger===swarm.get("status")){fn(swarm)}})};function PredictionMonitor(model,opts){opts=opts||{};this._getOutputDataOpts=opts.outputDataOptions||{limit:100,shift:true};this._model=model;this._dataListeners=[];this._lastRowIdSeen=opts.lastRowIdSeen||-1;Monitor.call(this,this._outputPoller,opts)}PredictionMonitor.prototype=GROK.util.heir(Monitor.prototype);PredictionMonitor.prototype.constructor=Monitor;PredictionMonitor.prototype._outputPoller=function(cb){var me=this;this._print("polling for new model output...");this._model.getOutputData(me._getOutputDataOpts,function(err,output){var newDataExists=false,unprocessedData,lastRowIdSeen=me._lastRowIdSeen;if(err){me._print(err);return me._fire("error",err)}unprocessedData=output.data.slice(1,output.data.length);output.data=me._processOutputData(output.data,output.meta);if(output.data.length&&lastRowIdSeen!==extractLastRowId(output)){newDataExists=true;me._lastNewDataTime=new Date}me._data(output,unprocessedData);me._lastPollTime=(new Date).getTime();cb(output,newDataExists)})};PredictionMonitor.prototype.onData=function(fn){this._dataListeners.push(fn)};PredictionMonitor.prototype._data=function(chunk,unProcessedChunk){this._print("notifying "+this._dataListeners.length+" listener of new data");this._dataListeners.forEach(function(listener){listener(chunk,unProcessedChunk)})};PredictionMonitor.prototype._processOutputData=function(data,meta){var me=this,startAt,result,secondsSinceLastNewData,dataOnly=data.slice(1,data.length),firstOutputRowId,lastOutputRowId;if(dataOnly.length===0||dataOnly[0].length===0){return[]}firstOutputRowId=dataOnly[0][0];lastOutputRowId=dataOnly[dataOnly.length-2][0];if(this._lastRowIdSeen===-1){result=dataOnly}else{if(firstOutputRowId<this._lastRowIdSeen){startAt=findIndex(dataOnly,function(row){return row[0]===me._lastRowIdSeen+1});if(!startAt){result=[]}else{result=dataOnly.slice(startAt)}}else if(firstOutputRowId+1===this._lastRowIdSeen){result=dataOnly}else{me._print("data gap");me._fire("error",new Error("There was a data gap while retrieving predictions from the API."));result=dataOnly}}if(this._lastRowIdSeen===lastOutputRowId){secondsSinceLastNewData=((new Date).getTime()-this._lastNewDataTime)/1e3;if(meta.modelStatus!=="swarming"&&secondsSinceLastNewData>this._timeout){this._print("timeout");this.stop()}}this._lastRowIdSeen=lastOutputRowId;return result};GROK.SwarmMonitor=SwarmMonitor;GROK.PredictionMonitor=PredictionMonitor})(window);(function(global){var SETTIMEOUT=global.setTimeout,doc=global.document,callback_counter=0;global.jXHR=function(){var script_url,script_loaded,scriptElem,publicAPI=null;function removeScript(){try{scriptElem.parentNode.removeChild(scriptElem)}catch(err){}}function reset(){script_loaded=false;script_url="";removeScript();scriptElem=null;fireReadyStateChange(0)}function ThrowError(msg){try{publicAPI.onerror.call(publicAPI,msg,script_url)}catch(err){throw new Error(msg)}}function handleScriptLoad(){if(this.readyState&&this.readyState!=="complete"&&this.readyState!=="loaded"||script_loaded){return}this.onload=this.onreadystatechange=null;script_loaded=true;if(publicAPI.readyState!==4)ThrowError("Script failed to load ["+script_url+"].");removeScript()}function fireReadyStateChange(rs,args){args=args||[];publicAPI.readyState=rs;if(typeof publicAPI.onreadystatechange==="function")publicAPI.onreadystatechange.apply(publicAPI,args)}publicAPI={onerror:null,onreadystatechange:null,readyState:0,open:function(method,url){reset();internal_callback="cb"+callback_counter++;(function(icb){global.jXHR[icb]=function(){try{fireReadyStateChange.call(publicAPI,4,arguments)}catch(err){publicAPI.readyState=-1;ThrowError("Script failed to run ["+script_url+"].")}global.jXHR[icb]=null}})(internal_callback);script_url=url.replace(/=\?/,"=jXHR."+internal_callback);fireReadyStateChange(1)},send:function(){SETTIMEOUT(function(){scriptElem=doc.createElement("script");scriptElem.setAttribute("type","text/javascript");scriptElem.onload=scriptElem.onreadystatechange=function(){handleScriptLoad.call(scriptElem)};scriptElem.setAttribute("src",script_url);doc.getElementsByTagName("head")[0].appendChild(scriptElem)},0);fireReadyStateChange(2)},setRequestHeader:function(){},getResponseHeader:function(){return""},getAllResponseHeaders:function(){return[]}};reset();return publicAPI}})(window);