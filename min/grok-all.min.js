
/*
 * ----------------------------------------------------------------------
 *  Copyright (C) 2006-2012 Numenta Inc. All rights reserved.
 *
 *  The information and source code contained herein is the
 *  exclusive property of Numenta Inc. No part of this software
 *  may be used, reproduced, stored or distributed in any form,
 *  without explicit written authorization from Numenta Inc.
 * ---------------------------------------------------------------------- */(function(a){a.GROK={}})(window);(function(a){a.GROK.util={toUriParams:function(a){var b="",c;for(c in a)a.hasOwnProperty(c)&&(b+=c+"="+encodeURIComponent(a[c])+"&");return b=b.substr(0,b.length-1),b},isSet:function(a){return a!==undefined&&a!==null},shallowObjectClone:function(a){return JSON.parse(JSON.stringify(a))},heir:function(a){function b(){}return b.prototype=a,new b}},a.GROK.LOG={ALL:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,NONE:5},a.GROK.LOG_LEVEL=a.GROK.LOG.ERROR,a.GROK.log=function(a){this.LOG_LEVEL<=this.LOG.ALL&&console.log(a)},a.GROK.debug=function(a){this.LOG_LEVEL<=this.LOG.DEBUG&&(console.debug?console.debug(a):console.log(a))},a.GROK.info=function(a){this.LOG_LEVEL<=this.LOG.INFO&&console.info(a)},a.GROK.warn=function(a){this.LOG_LEVEL<=this.LOG.WARN&&console.warn(a)},a.GROK.error=function(a){this.LOG_LEVEL<=this.LOG.ERROR&&console.error(a)}})(window);(function(a){function f(a,c,d){var e=c+"?";a.onerror=d.failure,a.onreadystatechange=function(b){a.readyState===4&&(b.error&&d.failure&&d.failure(new Error(b.error)),d.success(JSON.parse(b)))},d.data?e+=b.util.toUriParams(d.data)+"&callback=?":e+="callback=?",a.open(null,e),a.send()}function g(a,b,f){var g,h,i=this._xhr,j=this._proxyEndpoint||d,k=this._apiKey;f.failure=f.failure||function(){},i.open(c,j),i.setRequestHeader("Content-Type","application/json;charset=UTF-8"),i.setRequestHeader(e,"1");for(h in f.headers)f.headers.hasOwnProperty(h)&&i.setRequestHeader(h,f.headers[h]);i.onreadystatechange=function(){var a;if(this.readyState==4&&this.status==200){if(f.success)if(this.responseText){try{a=JSON.parse(this.responseText)}catch(b){f.failure(new Error("Could not parse response text from API server: "+this.responseText))}a.errors?f.failure(new Error(a.errors[0])):f.success(a)}else f.success()}else this.readyState==4&&this.status!=200&&f.failure&&f.failure(new Error("There was an XHR error, status is: "+this.status))},g={proxy:{method:b,endpoint:a}},k&&(g.apiKey=k),f.data&&(g.proxy.data=f.data),i.send(JSON.stringify(g))}function h(a,b){return b.forceProxy?!1:a==="GET"}var b=a.GROK,c="POST",d="/grok",e="x-grok";b.Request=function(c){var d=c.endpoint,e=c.version,f=c.apiKey,g=c.proxyEndpoint,h="";if(!d||!e)throw new Error("Cannot create GROK.Request object without endpoint and version: \"new GROK.Request('/endpoint', 'version'\"");this._apiKey=f,this._proxyEndpoint=g,this._xhr=new XMLHttpRequest,this._jxhr=new a.jXHR,d.substr(d.length-1,1)!=="/"&&(h="/"),this._root=d+h+e,this.constructor=b.Request},b.Request.prototype.send=function(a){var b=a.method||"GET",c=a.url||this._root+"/"+a.path;b=b.toUpperCase(),h(b,a)?f(this._jxhr,c,a):g.call(this,c,b,a)}})(window);(function(a){var b=a.GROK,c={ENDPOINT:"http://api.numenta.com/",VERSION:"v2",FORCE_PROXY:!0};b.ApiObject=function(a,b){b=b||{},a=a||{},this.setScalars(a),this.setEndpoint(b.endpoint||c.ENDPOINT),this.setProxyEndpoint(b.proxyEndpoint),this.setVersion(b.version||c.VERSION),this.setHeaders(b.httpHeaders||{}),this.setUserId(b.userId),this.setApiKey(b.apiKey)},b.ApiObject.FORCE_PROXY=c.FORCE_PROXY,b.ApiObject.prototype.getAttrs=function(){var a=this._scalars,b=this._details,c={},d;for(d in a)a.hasOwnProperty(d)&&d.indexOf("_")!==0&&(c[d]=a[d]);for(d in b)b.hasOwnProperty(d)&&d.indexOf("_")!==0&&(c[d]=b[d]);return c},b.ApiObject.prototype.getAttr=function(a){return this.get(a)},b.ApiObject.prototype.get=function(a){var b=this._scalars[a];return!b&&this._details&&(b=this._details[a]),b},b.ApiObject.prototype.getId=function(){return this.get("id")},b.ApiObject.prototype.setEndpoint=function(a){this._apiEndpoint=a},b.ApiObject.prototype.setProxyEndpoint=function(a){this._proxyEndpoint=a},b.ApiObject.prototype.getProxyEndpoint=function(){return this._proxyEndpoint},b.ApiObject.prototype.getEndpoint=function(){return this._apiEndpoint},b.ApiObject.prototype.setVersion=function(a){this._apiVersion=a},b.ApiObject.prototype.getVersion=function(){return this._apiVersion},b.ApiObject.prototype.setUserId=function(a){this._userId=a},b.ApiObject.prototype.getUserId=function(){return this._userId},b.ApiObject.prototype.setApiKey=function(a){this._apiKey=a},b.ApiObject.prototype.getApiKey=function(){return this._apiKey},b.ApiObject.prototype.setHeaders=function(a){this._httpHeaders=a||{}},b.ApiObject.prototype.getHeaders=function(){return this._httpHeaders},b.ApiObject.prototype.expand=function(a,c){b.debug("ApiObject.expand for "+this.constructor.NAMESPACE);var d=this,e=a.NAMESPACE,f=e.substr(0,e.length-1),g=this.get("url");b.debug("Expanding "+f),this.makeRequest({method:"GET",url:g,success:function(a){var b=a[f];d.setDetails(b),c(null,d.getDetails())},failure:function(a){c(a)}})},b.ApiObject.prototype.delete=function(a){b.debug("ApiObject.delete for "+this.constructor.NAMESPACE);var c=this;this.makeRequest({method:"DELETE",url:this.get("url"),success:function(){var b;for(b in c)delete c[b];a()},failure:function(b){a(b)}})},b.ApiObject.prototype.makeRequest=function(c){b.info("GROK.ApiObject.makeRequest for "+this.constructor.NAMESPACE),b.debug(c);var d,e,f=b.util.shallowObjectClone(this._httpHeaders);if(!c.url&&!c.path){e=new Error('Cannot make request without an absolute "url" or relative "path".');if(c.failure){c.failure(e);return}throw e}if(!c.headers)c.headers=f;else for(d in f)c.headers[d]||(c.headers[d]=f[d]);b.util.isSet(c.forceProxy)||(c.forceProxy=b.ApiObject.FORCE_PROXY),(new a.GROK.Request({endpoint:this.getEndpoint(),version:this.getVersion(),apiKey:this.getApiKey(),proxyEndpoint:this.getProxyEndpoint()})).send(c)},b.ApiObject.prototype.setScalar=function(a,b){this._scalars[a]=b},b.ApiObject.prototype.setScalars=function(a,b){var c;typeof b=="undefined"&&(b=!0);if(b)this._scalars=a;else for(c in a)this._scalars[c]=a[c]},b.ApiObject.prototype.getScalars=function(){return this._scalars||{}},b.ApiObject.prototype.getScalar=function(a){return this._scalars[a]},b.ApiObject.prototype.setDetails=function(a){this._details=a},b.ApiObject.prototype.setDetail=function(a,b){this._details[a]=b},b.ApiObject.prototype.getDetails=function(){return this._details||{}},b.ApiObject.prototype.getDetail=function(a){return this._details[a]},b.ApiObject.prototype.hasDetails=function(){return b.util.isSet(this._details)},b.ApiObject.prototype.populate=function(a){this.expand(this.constructor,a)},b.ApiObject.prototype.update=function(a,b){this.updateObject(this.constructor,a,b)},b.ApiObject.prototype.listObjects=function(){b.debug("GROK.ApiObject.listObjects for "+this.constructor.NAMESPACE);var a=arguments[0],c=typeof arguments[1]=="function"?{}:arguments[1],d=typeof arguments[1]=="function"?arguments[1]:arguments[2],e=this,f=a.NAMESPACE,g=this.get(f+"Url");this.makeRequest({method:"GET",url:g,data:c,success:function(b){var c=0,g=b[f];for(;c<g.length;c++)g[c]=new a(g[c],e._getDefaultChildOptions()),g[c].setScalar("_parent",e);d(null,g)},failure:function(a){d(a)}})},b.ApiObject.prototype.createObject=function(a,c,d){b.debug("GROK.ApiObject.createObject for "+this.constructor.NAMESPACE);var e=this,f=a.NAMESPACE,g=f.substr(0,f.length-1),h={};h[g]=c,this.makeRequest({method:"POST",url:this.get(f+"Url"),data:h,success:function(b){var c=new a(b[g],e._getDefaultChildOptions());c.setScalar("_parent",e),d(null,c)},failure:function(a){d(a)}})},b.ApiObject.prototype.getObject=function(a,c,d){b.debug("GROK.ApiObject.getObject for "+this.constructor.NAMESPACE);var e=this,f=a.NAMESPACE,g=f.substr(0,f.length-1);this.makeRequest({method:"GET",url:this.get(f+"Url")+"/"+c,success:function(b){d(null,new a(b[g],e._getDefaultChildOptions()))},failure:function(a){d(a)}})},b.ApiObject.prototype.updateObject=function(a,c,d){b.debug("GROK.ApiObject.updateObject for "+this.constructor.NAMESPACE);var e=this,f,g=a.NAMESPACE,h=g.substr(0,g.length-1),i,j={};i=e.getAttrs();for(f in c)c.hasOwnProperty(f)&&(i[f]=c[f]);j[h]=i,this.makeRequest({method:"POST",url:this.get("url"),data:j,success:function(){e.setScalars(i,!1),d()},failure:function(a){d(a)}})},b.ApiObject.prototype._getDefaultChildOptions=function(){return{endpoint:this.getEndpoint(),proxyEndpoint:this.getProxyEndpoint(),version:this.getVersion(),headers:this.getHeaders(),userId:this.getUserId(),apiKey:this.getApiKey()}},b.ApiObject.prototype.toJSON=function(){var a=[this.getAttrs()].concat(Array.prototype.slice.call(arguments));return JSON.stringify.apply(JSON,a)}})(window);(function(a){var b=a.GROK;b.Stream=function(a,c){b.ApiObject.apply(this,arguments),this.constructor=b.Stream},b.Stream.prototype=b.util.heir(b.ApiObject.prototype),b.Stream.prototype.constructor=b.ApiObject,b.Stream.NAMESPACE="streams",b.Stream.prototype.addData=function(a,b){this.makeRequest({method:"POST",url:this.get("dataUrl"),data:{input:a},success:function(){b()},failure:function(a){b(a)}})},b.Stream.prototype.getInputData=function(a){this.makeRequest({method:"GET",url:this.get("dataUrl"),success:function(b){b.input?a(null,b.input):a(new Error('malformed API response! Expected "input" key.'))},failure:function(b){a(b)}})}})(window);(function(a){var b=a.GROK,c=1e3,d=500;b.Model=function(a,c){b.ApiObject.apply(this,arguments),this.constructor=b.Model},b.Model.prototype=b.util.heir(b.ApiObject.prototype),b.Model.prototype.constructor=b.ApiObject,b.Model.NAMESPACE="models",b.Model.prototype.getName=function(){return this.getScalar("name")},b.Model.prototype.clone=function(a){var b=this,c=this.getScalar("_parent"),d=this.getAttrs();this.hasDetails()||this.populate(function(c){c?a(c):d=b.getAttrs()}),d.aggregation||(d.aggregation={interval:"seconds"}),c.createModel(d,a)},b.Model.prototype.getStream=function(a){var b=this.get("streamId"),c=this.get("_parent");c.getStream(b,a)},b.Model.prototype.getOutputData=function(a,b){var c=this,d,e,f;typeof a=="function"?d=a:(e=a.limit||1e3,f=a.align,d=b),this.makeRequest({data:{limit:e},url:this.get("dataUrl"),success:function(a){var b=a.output||{data:[]};f&&(b=c.alignOutputData(b)),d(null,b)},failure:function(a){d(a)}})},b.Model.prototype.listSwarms=function(a){this.makeRequest({method:"GET",url:this.get("swarmsUrl"),success:function(b){a(null,b.swarms)},failure:function(b){a(b)}})},b.Model.prototype.startSwarm=function(a,d){var e=this,f,g;typeof a=="function"?f=a:(g=a.size||"medium",f=d),this.makeRequest({method:"POST",data:{options:{size:g}},url:this.get("swarmsUrl"),success:function(a){var d=a.swarm,g=new b.Swarm(d);d._parent=e,f(null,g,new b.SwarmMonitor(g,c))},failure:function(a){f(a)}})},b.Model.prototype.stopSwarm=function(a){this.makeRequest({method:"POST",url:this.get("commandsUrl"),data:{command:"stop"},success:function(){a()},failure:function(b){a(b)}})},b.Model.prototype.getSwarm=function(a,c){this.makeRequest({method:"GET",url:this.get("swarmsUrl")+"/"+a,success:function(a){c(null,new b.Swarm(a.swarm))},failure:function(a){c(a)}})},b.Model.prototype.alignOutputData=function(a){var b=a.names,c=a.data,d=[],e,f,g,h=[];b.forEach(function(a,b){(a.match("Metric temporal")||a.match("Predicted"))&&h.push(b)}),c.length&&c[0].forEach(function(){d.push("")}),c.push(d);for(e=c.length-1;e>=0;e--)g=c[e],f=[],e!==c.length-1&&h.forEach(function(a){var b=g[a];c[e+1][a]=b,e===0&&(c[e][a]="")});return c.unshift(b),c},b.Model.prototype.monitorPredictions=function(a){var c;a=a||{},a.pollFrequency=a.pollFrequency||1e3,a.limit=typeof a.limit=="undefined"?100:a.limit,a.lastRowIdSeen=a.startAt,c=new b.PredictionMonitor(this,{interval:a.pollFrequency,limit:a.limit,lastRowIdSeen:a.lastRowIdSeen}),a.onUpdate&&c.onData(a.onUpdate),a.onDone&&c.onDone(a.onDone),c.start()},b.Model.prototype.promote=function(a){function f(){var f=setInterval(function(){b.getOutputData(function(b,d){if(b)return a(b);!c&&d.data.length>=e&&(clearInterval(f),a(),c=!0)})},d)}function g(){b.getOutputData(function(c,g){var h;if(c)return a(c);e=g.data.length,h=setInterval(function(){b.populate(function(b,c){if(b)return a(b);c.status==="running"&&(clearInterval(h),f())})},d)})}var b=this,c,e;this.makeRequest({method:"POST",url:this.get("commandsUrl"),data:{command:"promote"},success:function(){g()},failure:function(b){a(b)}})}})(window);(function(a){var b=a.GROK;b.Swarm=function(a,c){b.ApiObject.apply(this,arguments),this.constructor=b.Swarm},b.Swarm.prototype=b.util.heir(b.ApiObject.prototype),b.Swarm.prototype.constructor=b.ApiObject,b.Swarm.NAMESPACE="swarms",b.Swarm.STATUS={STOPPED:"stopped",COMPLETED:"completed",CANCELLED:"cancelled",NOT_STARTED:"not_started",RUNNING:"running",SWARMING:"swarming",ERROR:"error"},b.Swarm.prototype.getStatus=function(a){var b=this.getScalar("_parent");b.getSwarm(this.getId(),a)}})(window);(function(a){var b=a.GROK;b.Project=function(a,c){b.ApiObject.apply(this,arguments),this.constructor=b.Project},b.Project.prototype=b.util.heir(b.ApiObject.prototype),b.Project.prototype.constructor=b.ApiObject,b.Project.NAMESPACE="projects",b.Project.prototype.getName=function(){return this.getScalar("name")},b.Project.prototype.getDescription=function(a){var b=this,c=this.getAttr("description");c?a(null,c):this.populate(function(c){c?a(c):a(null,b.getDetail("description"))})},b.Project.prototype.setName=function(a,b){this.update({name:a},b)},b.Project.prototype.listModels=function(a){this.listObjects(b.Model,a)},b.Project.prototype.listStreams=function(a){this.listObjects(b.Stream,a)},b.Project.prototype.createModel=function(a,c){c=c||function(){},this.createObject(b.Model,a,c)},b.Project.prototype.getModel=function(a,c){var d=this;this.getObject(b.Model,a,function(a,b){if(a)return c(a);b.setScalar("_parent",d),c(null,b)})},b.Project.prototype.createStream=function(a,c){c=c||function(){},this.createObject(b.Stream,a,c)}})(window);(function(a){var b=a.GROK;b.Client=function(a,c){this._validated=!1;if(!b.util.isSet(a))throw new Error('Cannot create GROK Client without an API Key:\nnew GROK.Client("my-api-key");');c=c||{},c.apiKey=a,b.ApiObject.call(this,{},c),c.user&&c.user.id&&(this.setScalars(c.user),this._validated=!0),this.constructor=b.Client},b.Client.prototype=b.util.heir(b.ApiObject.prototype),b.Client.prototype.constructor=b.ApiObject,b.Client.NAMESPACE="users",b.Client.prototype.init=function(a){b.info("Connecting to Grok...");var c=this;this.makeRequest({method:"GET",path:"users",success:function(d){!d||!d.users?a(new Error("Client cannot understand response from API at "+c.getEndpoint()+". Are you sure this is the proper Grok API URL?")):(b.info("Connected to Grok."),c.setScalars(d.users[0]),c._validated=!0,a(null))},failure:function(b){b.message==="Unauthorized"?a(new Error('Invalid API key: "'+c.getApiKey()+'"')):a(b)}})},b.Client.prototype.isValidated=function(){return this._validated},b.Client.prototype.createProject=function(a,c){c=c||function(){},this.createObject(b.Project,{name:a},c)},b.Client.prototype.createModel=function(a,c){c=c||function(){},this.createObject(b.Model,a,c)},b.Client.prototype.createStream=function(a,c){c=c||function(){},this.createObject(b.Stream,a,c)},b.Client.prototype.getStream=function(a,c){c=c||function(){},this.getObject(b.Stream,a,function(b,d){b&&b.message==="Not Found"?c(new Error("Input stream '"+a+"' not found")):b?c(b):c(null,d)})},b.Client.prototype.getProject=function(a,c){this.getObject(b.Project,a,c)},b.Client.prototype.getModel=function(a,c){var d=this;this.getObject(b.Model,a,function(a,b){if(a)return c(a);b.setScalar("_parent",d),c(null,b)})},b.Client.prototype.listProjects=function(a){this.listObjects(b.Project,a)},b.Client.prototype.listModels=function(a){this.listObjects(b.Model,{all:!0},a)},b.Client.prototype.listStreams=function(a){this.listObjects(b.Stream,a)}})(window);(function(a){function e(a,b,c){var d;return Array.prototype.some.call(a,function(a,e,f){if(b.call(c,a,e,f))return d=e,!0}),d}function f(a,b){b=b||{},this._poller=a,this._interval=b.interval||c,this._debug=b.debug,this._pollIntervalId=-1,this._pollListeners=[],this._doneListeners=[],this._errorListeners=[],this._done=!1}function g(a,b){this._swarm=a,this._lastStatus=undefined,this._statusChangeListeners=[],f.call(this,this._swarmPoller,b)}function h(a,b){b=b||{},b.interval=b.interval||1e3,this._limit=b.limit||100,this._repeatTimes=b.repeatTimes||15,this._model=a,this._dataListeners=[],this._lastRowSeen=b.lastRowIdSeen||-1,this._doneCounter=0,f.call(this,this._outputPoller,b)}var b=a.GROK,c=2e3,d="any";f.prototype.onPoll=function(a){return this._pollListeners.push(a),this},f.prototype.onDone=function(a){return this._doneListeners.push(a),this},f.prototype.onError=function(a){return this._errorListeners.push(a),this},f.prototype._fire=function(a,b){this._print("Monitor calling "+a+" listeners"),a==="done"&&(this._done=!0),this["_"+a+"Listeners"].forEach(function(a){a(b)})},f.prototype.start=function(){var a=this,b=!1;return this._startTime=(new Date).getTime(),this._print("Monitor starting"),this._pollIntervalId=setInterval(function(){if(b)return;b=!0,a._print("Monitor polling..."),a._poller(function(c){a._print("Monitor received poll result: "),a._done||a._fire("poll",c),b=!1})},this._interval),this},f.prototype.stop=function(){var a=(new Date).getTime()-this._startTime;return this._print("Monitor stopping"),clearInterval(this._pollIntervalId),this._fire("done",a),a},f.prototype._print=function(a){this._debug&&console.log(a)},g.prototype=b.util.heir(f.prototype),g.prototype.constructor=f,g.prototype._swarmPoller=function(a){var b=this;this._print("polling for swarm..."),this._swarm.getStatus(function(c,d){if(c)return b._fire("error",c);var e=d.get("status");b._lastStatus&&e!==b._lastStatus&&b.statusChange(d),b._lastStatus=e,a(d)})},g.prototype.onStatusChange=function(a){this._statusChangeListeners.push({trigger:d,fn:a})},g.prototype.onStatus=function(a,b){this._statusChangeListeners.push({trigger:a,fn:b})},g.prototype.statusChange=function(a){this._print("SwarmMonitor calling statusChange listeners"),this._statusChangeListeners.forEach(function(b){var c=b.trigger,e=b.fn;(c===d||c===a.get("status"))&&e(a)})},h.prototype=b.util.heir(f.prototype),h.prototype.constructor=f,h.prototype._outputPoller=function(a){var b=this;this._print("polling for new model output..."),this._model.getOutputData({limit:b._limit},function(c,d){if(c)return b._fire("error",c);d.data=b._processOutputData(d.data),b._data(d),a(d)})},h.prototype.onData=function(a){this._dataListeners.push(a)},h.prototype._data=function(a){this._dataListeners.forEach(function(b){b(a)})},h.prototype._processOutputData=function(a){var b=this,c,d,f,g;return a[0].length===0?[]:(f=a[0][0],g=a[a.length-1][0],this._lastRowSeen===-1?d=a:f<this._lastRowSeen?(c=e(a,function(a){return a[0]===b._lastRowSeen+1}),d=a.slice(c)):f+1===this._lastRowSeen?d=a:(b._fire("error",new Error("There was a data gap while retrieving predictions from the API.")),d=a),this._lastRowSeen===g&&(this._doneCounter>this._repeatTimes?this.stop():this._doneCounter++),this._lastRowSeen=g,d)},b.SwarmMonitor=g,b.PredictionMonitor=h})(window);(function(a){var b=a.setTimeout,c=a.document,d=0;a.jXHR=function(){function i(){try{g.parentNode.removeChild(g)}catch(a){}}function j(){f=!1,e="",i(),g=null,m(0)}function k(a){try{h.onerror.call(h,a,e)}catch(b){throw new Error(a)}}function l(){if(this.readyState&&this.readyState!=="complete"&&this.readyState!=="loaded"||f)return;this.onload=this.onreadystatechange=null,f=!0,h.readyState!==4&&k("Script failed to load ["+e+"]."),i()}function m(a,b){b=b||[],h.readyState=a,typeof h.onreadystatechange=="function"&&h.onreadystatechange.apply(h,b)}var e,f,g,h=null;return h={onerror:null,onreadystatechange:null,readyState:0,open:function(b,c){j(),internal_callback="cb"+d++,function(b){a.jXHR[b]=function(){try{m.call(h,4,arguments)}catch(c){h.readyState=-1,k("Script failed to run ["+e+"].")}a.jXHR[b]=null}}(internal_callback),e=c.replace(/=\?/,"=jXHR."+internal_callback),m(1)},send:function(){b(function(){g=c.createElement("script"),g.setAttribute("type","text/javascript"),g.onload=g.onreadystatechange=function(){l.call(g)},g.setAttribute("src",e),c.getElementsByTagName("head")[0].appendChild(g)},0),m(2)},setRequestHeader:function(){},getResponseHeader:function(){return""},getAllResponseHeaders:function(){return[]}},j(),h}})(window);